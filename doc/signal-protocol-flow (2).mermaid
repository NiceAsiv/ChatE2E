graph TB
    subgraph "密钥初始化"
        A1["Alice生成密钥对"] -->|生成| A2["身份密钥对"]
        A1 -->|生成| A3["预签名密钥对"]
        A1 -->|生成| A4["一次性预密钥对"]
        
        B1["Bob生成密钥对"] -->|生成| B2["身份密钥对"]
        B1 -->|生成| B3["预签名密钥对"]
        B1 -->|生成| B4["一次性预密钥对"]
    end

    subgraph "X3DH密钥协商"
        I1["Alice(发起方)计算DH"] -->|DH1| I2["IKa × SPKb"]
        I1 -->|DH2| I3["EKa × IKb"]
        I1 -->|DH3| I4["EKa × SPKb"]
        I1 -->|DH4| I5["EKa × OPKb"]
        
        I2 & I3 & I4 & I5 -->|组合| SK1["共享密钥SK"]
        
        SK1 -->|HKDF| RK1["根密钥(Root Key)"]
        RK1 -->|派生| CK1["发送链密钥"]
        RK1 -->|派生| CK2["接收链密钥"]
    end

    subgraph "消息加密流程"
        M1["发送方"] -->|"1. 使用发送链密钥"| M2["派生消息密钥"]
        M2 -->|"2. HKDF派生"| M3["新的发送链密钥"]
        M2 -->|"3. AESGCM加密"| M4["加密消息"]
        M4 -->|"4. 添加头信息"| M5["最终密文"]
    end

    subgraph "消息解密流程"
        D1["接收方"] -->|"1. 验证消息来源"| D2["选择正确链密钥"]
        D2 -->|"2. HKDF派生"| D3["消息密钥"]
        D3 -->|"3. AESGCM解密"| D4["解密消息"]
        D2 -->|"4. 更新"| D5["新的接收链密钥"]
    end

    A4 --> I1
    B4 --> I1
    M5 --> D1
